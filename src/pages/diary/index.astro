---
import BaseLayout from '../../layouts/BaseLayout.astro';
import DiaryEntry from '../../components/DiaryEntry.astro';
import { getCollection } from 'astro:content';
const base = import.meta.env.BASE_URL.replace(/\/$/, '');

const allEntries = await getCollection('diary');

// Sort by chapter then session
allEntries.sort((a, b) => {
  if (a.data.chapter !== b.data.chapter) return a.data.chapter - b.data.chapter;
  return a.data.session - b.data.session;
});

// Group by chapter
const chapters = new Map<number, { title?: string; entries: typeof allEntries }>();
for (const entry of allEntries) {
  const ch = entry.data.chapter;
  if (!chapters.has(ch)) {
    chapters.set(ch, { title: entry.data.chapterTitle, entries: [] });
  }
  chapters.get(ch)!.entries.push(entry);
}
---

<BaseLayout title="Campaign Diary">
  <h1 class="font-serif text-3xl font-bold text-ink-900 mb-2">Campaign Diary</h1>
  <p class="text-ink-400 mb-6">Session-by-session accounts of <em>The Rise of Atropos</em>.</p>

  <div id="search" class="mb-8"></div>

  <link href={`${base}/pagefind/pagefind-ui.css`} rel="stylesheet" />
  <script is:inline define:vars={{ base }}>
    window.addEventListener('DOMContentLoaded', function() {
      var script = document.createElement('script');
      script.src = base + '/pagefind/pagefind-ui.js';
      script.onload = function() {
        new PagefindUI({
          element: '#search',
          showSubResults: true,
          showImages: false,
          baseUrl: base + '/',
        });
      };
      document.head.appendChild(script);
    });
  </script>

  {allEntries.length === 0 ? (
    <div class="text-center py-12 text-ink-400">
      <p>No diary entries yet. Run the conversion script to import campaign sessions.</p>
      <code class="text-sm mt-2 block">python scripts/convert-docx.py</code>
    </div>
  ) : (
    <div class="space-y-8">
      {[...chapters.entries()].map(([chapterNum, chapter]) => (
        <section>
          <h2 class="font-serif text-xl font-semibold text-ink-800 mb-3 pb-2 border-b border-parchment-200">
            Chapter {chapterNum}{chapter.title ? `: ${chapter.title}` : ''}
          </h2>
          <div>
            {chapter.entries.map(entry => (
              <DiaryEntry
                title={entry.data.title}
                chapter={entry.data.chapter}
                chapterTitle={entry.data.chapterTitle}
                session={entry.data.session}
                summary={entry.data.summary}
                slug={entry.id}
              />
            ))}
          </div>
        </section>
      ))}
    </div>
  )}
</BaseLayout>

<style is:global>
  .pagefind-ui-container {
    --pagefind-ui-scale: 0.9;
    --pagefind-ui-primary: var(--color-accent-600);
    --pagefind-ui-text: var(--color-ink-800);
    --pagefind-ui-background: var(--color-parchment-50);
    --pagefind-ui-border: var(--color-parchment-300);
    --pagefind-ui-tag: var(--color-parchment-200);
    --pagefind-ui-border-width: 1px;
    --pagefind-ui-border-radius: 8px;
    --pagefind-ui-font: var(--font-sans);
  }

  .pagefind-ui .pagefind-ui__search-input {
    font-family: var(--font-sans);
    background: var(--color-parchment-100);
  }

  .pagefind-ui .pagefind-ui__result-link {
    color: var(--color-accent-600);
    font-family: var(--font-serif);
  }

  .pagefind-ui .pagefind-ui__result-link:hover {
    color: var(--color-accent-700);
  }

  .pagefind-ui .pagefind-ui__result-excerpt {
    color: var(--color-ink-500);
  }
</style>

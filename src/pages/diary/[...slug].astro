---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, render } from 'astro:content';

export async function getStaticPaths() {
  const entries = await getCollection('diary');
  return entries.map(entry => ({
    params: { slug: entry.id },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await render(entry);

// Get prev/next entries for navigation
const allEntries = await getCollection('diary');
allEntries.sort((a, b) => {
  if (a.data.chapter !== b.data.chapter) return a.data.chapter - b.data.chapter;
  return a.data.session - b.data.session;
});

const currentIndex = allEntries.findIndex(e => e.id === entry.id);
const prev = currentIndex > 0 ? allEntries[currentIndex - 1] : null;
const next = currentIndex < allEntries.length - 1 ? allEntries[currentIndex + 1] : null;
const base = import.meta.env.BASE_URL.replace(/\/$/, '');
---

<BaseLayout title={entry.data.title}>
  <article>
    <div class="mb-6">
      <a href={`${base}/diary/`} class="text-sm text-ink-400 hover:text-accent-600 no-underline">&larr; Back to Diary</a>
    </div>

    <header class="mb-8">
      <div class="text-sm text-ink-400 mb-1 font-mono">
        Chapter {entry.data.chapter}{entry.data.chapterTitle ? `: ${entry.data.chapterTitle}` : ''} &middot; Session {entry.data.session}
      </div>
      <h1 class="font-serif text-3xl font-bold text-ink-900">{entry.data.title}</h1>
      {entry.data.summary && (
        <p class="mt-2 text-ink-500 italic">{entry.data.summary}</p>
      )}
    </header>

    <div class="prose">
      <Content />
    </div>

    <nav class="flex justify-between mt-12 pt-6 border-t border-parchment-200 text-sm">
      {prev ? (
        <a href={`${base}/diary/${prev.id}/`} class="text-ink-500 hover:text-accent-600 no-underline">
          &larr; {prev.data.title}
        </a>
      ) : <span />}
      {next ? (
        <a href={`${base}/diary/${next.id}/`} class="text-ink-500 hover:text-accent-600 no-underline">
          {next.data.title} &rarr;
        </a>
      ) : <span />}
    </nav>
  </article>
</BaseLayout>

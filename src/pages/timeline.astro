---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const allEntries = await getCollection('diary');
allEntries.sort((a, b) => {
  if (a.data.chapter !== b.data.chapter) return a.data.chapter - b.data.chapter;
  return a.data.session - b.data.session;
});

// Group by chapter
const chapters: Map<number, typeof allEntries> = new Map();
for (const entry of allEntries) {
  const ch = entry.data.chapter;
  if (!chapters.has(ch)) chapters.set(ch, []);
  chapters.get(ch)!.push(entry);
}

const base = import.meta.env.BASE_URL.replace(/\/$/, '');

// Chapter title fallback
function chapterTitle(entries: typeof allEntries): string {
  return entries[0]?.data.chapterTitle || `Chapter ${entries[0]?.data.chapter}`;
}
---

<BaseLayout title="Timeline" wide={true}>
  <h1 class="font-serif text-3xl font-bold text-ink-900 mb-2">Timeline</h1>
  <p class="text-ink-400 mb-8">A chronological record of all sessions across <em>The Rise of Atropos</em>.</p>

  <div class="timeline-wrapper">
    <!-- Main timeline -->
    <div class="timeline-main">
      {[...chapters.entries()].map(([chapterNum, entries], chapterIdx) => (
        <section id={`chapter-${chapterNum}`} class="timeline-chapter" data-chapter={chapterNum}>
          {/* Chapter header */}
          <div class="chapter-header">
            <span class="chapter-number">Chapter {chapterNum}</span>
            <span class="chapter-title">{chapterTitle(entries)}</span>
            <span class="chapter-count">{entries.length} sessions</span>
          </div>

          {/* Session nodes */}
          <div class="timeline-spine">
            {entries.map((entry, i) => {
              const peopleCount = entry.data.people?.length || 0;
              const placesCount = entry.data.places?.length || 0;
              const thingsCount = entry.data.things?.length || 0;
              const factionsCount = entry.data.factions?.length || 0;
              const side = i % 2 === 0 ? 'left' : 'right';

              return (
                <div class={`timeline-node timeline-node--${side}`}>
                  <div class="node-dot" />
                  <a href={`${base}/diary/${entry.id}/`} class="node-card">
                    <span class="node-label font-mono">
                      Ch.{entry.data.chapter} / S{entry.data.session}
                    </span>
                    <span class="node-title">{entry.data.title}</span>
                    {(peopleCount > 0 || placesCount > 0 || thingsCount > 0 || factionsCount > 0) && (
                      <div class="node-tags">
                        {peopleCount > 0 && <span class="tag tag--people">{peopleCount} people</span>}
                        {placesCount > 0 && <span class="tag tag--places">{placesCount} places</span>}
                        {thingsCount > 0 && <span class="tag tag--things">{thingsCount} things</span>}
                        {factionsCount > 0 && <span class="tag tag--factions">{factionsCount} factions</span>}
                      </div>
                    )}
                  </a>
                </div>
              );
            })}
          </div>
        </section>
      ))}
    </div>

    <!-- Chapter navigation sidebar -->
    <nav class="chapter-nav" aria-label="Chapter navigation">
      <h2 class="text-sm font-semibold text-ink-500 uppercase tracking-wider mb-3">Chapters</h2>
      <ul class="space-y-1">
        {[...chapters.entries()].map(([chapterNum, entries]) => (
          <li>
            <a
              href={`#chapter-${chapterNum}`}
              class="chapter-nav-link"
              data-chapter-link={chapterNum}
            >
              <span class="chapter-nav-num">{chapterNum}.</span>
              <span class="chapter-nav-name">{chapterTitle(entries)}</span>
            </a>
          </li>
        ))}
      </ul>
    </nav>
  </div>
</BaseLayout>

<style>
  /* Layout */
  .timeline-wrapper {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  @media (min-width: 1024px) {
    .timeline-wrapper {
      display: grid;
      grid-template-columns: 1fr 240px;
      gap: 2rem;
    }
  }

  /* Chapter navigation sidebar */
  .chapter-nav {
    display: none;
  }

  @media (min-width: 1024px) {
    .chapter-nav {
      display: block;
      background: var(--color-parchment-100);
      border-radius: 0.5rem;
      padding: 1rem;
      position: sticky;
      top: 5rem;
      align-self: start;
      max-height: calc(100vh - 7rem);
      overflow-y: auto;
    }
  }

  .chapter-nav-link {
    display: flex;
    gap: 0.375rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.8125rem;
    line-height: 1.4;
    color: var(--color-ink-500);
    text-decoration: none;
    transition: background-color 0.15s, color 0.15s;
  }

  .chapter-nav-link:hover {
    background: var(--color-parchment-200);
    color: var(--color-ink-800);
    text-decoration: none;
  }

  .chapter-nav-link.active {
    background: var(--color-parchment-300);
    color: var(--color-ink-900);
    font-weight: 600;
  }

  .chapter-nav-num {
    flex-shrink: 0;
    font-variant-numeric: tabular-nums;
    min-width: 1.5rem;
  }

  /* Chapter headers */
  .chapter-header {
    display: flex;
    align-items: baseline;
    gap: 0.75rem;
    padding: 1rem 0 0.5rem;
    margin-bottom: 0.5rem;
    border-bottom: 1px solid var(--color-parchment-300);
  }

  .chapter-number {
    font-family: var(--font-serif);
    font-size: 0.875rem;
    font-weight: 700;
    color: var(--color-ink-400);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .chapter-title {
    font-family: var(--font-serif);
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--color-ink-900);
  }

  .chapter-count {
    font-size: 0.75rem;
    color: var(--color-ink-300);
    margin-left: auto;
  }

  /* Spine */
  .timeline-spine {
    position: relative;
    padding: 1rem 0 2rem;
  }

  .timeline-spine::before {
    content: '';
    position: absolute;
    left: 0.5rem;
    top: 0;
    bottom: 0;
    width: 2px;
    background: var(--color-parchment-300);
  }

  @media (min-width: 1024px) {
    .timeline-spine::before {
      left: 50%;
      transform: translateX(-50%);
    }
  }

  /* Nodes */
  .timeline-node {
    position: relative;
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    padding: 0.5rem 0;
    padding-left: 2rem;
  }

  @media (min-width: 1024px) {
    .timeline-node {
      width: 50%;
      padding-left: 0;
    }

    .timeline-node--left {
      margin-left: 0;
      padding-right: 2rem;
      justify-content: flex-end;
      text-align: right;
    }

    .timeline-node--right {
      margin-left: 50%;
      padding-left: 2rem;
    }

    .timeline-node--left .node-tags {
      justify-content: flex-end;
    }
  }

  /* Dot marker */
  .node-dot {
    position: absolute;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--color-parchment-400);
    border: 2px solid var(--color-parchment-200);
    left: 4px;
    top: 0.875rem;
    z-index: 1;
  }

  @media (min-width: 1024px) {
    .timeline-node--left .node-dot {
      left: auto;
      right: -5px;
    }

    .timeline-node--right .node-dot {
      left: -5px;
    }
  }

  /* Card */
  .node-card {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
    padding: 0.625rem 0.875rem;
    background: var(--color-parchment-100);
    border: 1px solid var(--color-parchment-200);
    border-radius: 0.375rem;
    text-decoration: none;
    transition: border-color 0.15s, box-shadow 0.15s;
    width: 100%;
  }

  .node-card:hover {
    border-color: var(--color-parchment-400);
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
    text-decoration: none;
  }

  .node-label {
    font-size: 0.6875rem;
    color: var(--color-ink-300);
    letter-spacing: 0.02em;
  }

  .node-title {
    font-family: var(--font-serif);
    font-size: 0.9375rem;
    font-weight: 600;
    color: var(--color-ink-800);
    line-height: 1.3;
  }

  /* Entity tags */
  .node-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
    margin-top: 0.25rem;
  }

  .tag {
    font-size: 0.625rem;
    padding: 0.0625rem 0.375rem;
    border-radius: 9999px;
    font-weight: 500;
    line-height: 1.5;
  }

  .tag--people { background: #fef3c7; color: #92400e; }
  .tag--places { background: #d1fae5; color: #065f46; }
  .tag--things { background: #e0f2fe; color: #075985; }
  .tag--factions { background: #ede9fe; color: #5b21b6; }

  /* Scroll-driven reveal animations */
  @supports (animation-timeline: view()) {
    .timeline-node {
      opacity: 0;
      transform: translateY(1rem);
      animation: node-reveal linear both;
      animation-timeline: view();
      animation-range: entry 0% entry 30%;
    }

    @media (min-width: 1024px) {
      .timeline-node--left {
        transform: translateX(-1rem) translateY(0);
        animation-name: node-reveal-left;
      }

      .timeline-node--right {
        transform: translateX(1rem) translateY(0);
        animation-name: node-reveal-right;
      }
    }
  }

  @keyframes node-reveal {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes node-reveal-left {
    to {
      opacity: 1;
      transform: translateX(0) translateY(0);
    }
  }

  @keyframes node-reveal-right {
    to {
      opacity: 1;
      transform: translateX(0) translateY(0);
    }
  }
</style>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    const sections = document.querySelectorAll('.timeline-chapter');
    const links = document.querySelectorAll('.chapter-nav-link');
    if (!sections.length || !links.length) return;

    // Smooth scroll for chapter links
    links.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const target = document.querySelector(link.getAttribute('href'));
        if (target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
    });

    // IntersectionObserver for active chapter highlighting
    let activeChapter = null;
    const observer = new IntersectionObserver((entries) => {
      for (const entry of entries) {
        if (entry.isIntersecting) {
          const ch = entry.target.dataset.chapter;
          if (ch !== activeChapter) {
            activeChapter = ch;
            links.forEach(l => {
              l.classList.toggle('active', l.dataset.chapterLink === ch);
            });
          }
        }
      }
    }, { rootMargin: '-20% 0px -60% 0px' });

    sections.forEach(s => observer.observe(s));
  });
</script>

---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, render } from 'astro:content';

export async function getStaticPaths() {
  const entries = await getCollection('wiki');
  return entries.map(entry => ({
    params: { slug: entry.id },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await render(entry);

const base = import.meta.env.BASE_URL.replace(/\/$/, '');

const categoryColors: Record<string, string> = {
  People: 'bg-amber-100 text-amber-800',
  Places: 'bg-emerald-100 text-emerald-800',
  Things: 'bg-sky-100 text-sky-800',
  Factions: 'bg-violet-100 text-violet-800',
  Events: 'bg-rose-100 text-rose-800',
};

const statusColors: Record<string, string> = {
  Alive: 'bg-green-100 text-green-800',
  Dead: 'bg-red-100 text-red-800',
  Unknown: 'bg-gray-100 text-gray-600',
  Destroyed: 'bg-red-100 text-red-800',
  Active: 'bg-green-100 text-green-800',
  Inactive: 'bg-gray-100 text-gray-600',
  Disbanded: 'bg-gray-100 text-gray-600',
};

// Category â†’ frontmatter key mapping
const categoryToKey: Record<string, string> = {
  People: 'people',
  Places: 'places',
  Things: 'things',
  Factions: 'factions',
  Events: 'events',
};
const fmKey = categoryToKey[entry.data.category];

// Find all diary entries that reference this wiki entry
const allDiary = await getCollection('diary');
const appearances = allDiary.filter(d => {
  const arr = d.data[fmKey as keyof typeof d.data] as string[] | undefined;
  return arr?.includes(entry.id);
}).sort((a, b) => {
  if (a.data.chapter !== b.data.chapter) return a.data.chapter - b.data.chapter;
  return a.data.session - b.data.session;
});

// Group appearances by chapter
const byChapter = new Map<number, { title: string; entries: typeof appearances }>();
for (const d of appearances) {
  const ch = d.data.chapter;
  if (!byChapter.has(ch)) {
    byChapter.set(ch, { title: d.data.chapterTitle || `Chapter ${ch}`, entries: [] });
  }
  byChapter.get(ch)!.entries.push(d);
}

// Find first appearance diary entry
let firstAppearanceEntry = null;
if (entry.data.firstAppearance) {
  firstAppearanceEntry = allDiary.find(d => d.id === entry.data.firstAppearance) || null;
}
---

<BaseLayout title={entry.data.title} wide>
  <article>
    <div class="mb-6">
      <a href={`${base}/wiki/`} class="text-sm text-ink-400 hover:text-accent-600 no-underline">&larr; Back to Wiki</a>
    </div>

    <div class="lg:grid lg:grid-cols-[1fr_300px] lg:gap-8" data-pagefind-body>
      <!-- Main Content -->
      <div>
        <header class="mb-8">
          <div class="flex flex-wrap items-center gap-2 mb-2">
            <span class:list={['text-xs font-medium px-2 py-0.5 rounded-full', categoryColors[entry.data.category] || 'bg-parchment-200 text-ink-600']} data-pagefind-meta={`category:${entry.data.category}`}>
              {entry.data.category}
            </span>
            {entry.data.status && (
              <span class:list={['text-xs font-medium px-2 py-0.5 rounded-full', statusColors[entry.data.status] || 'bg-gray-100 text-gray-600']}>
                {entry.data.status}
              </span>
            )}
          </div>
          <h1 class="font-serif text-3xl font-bold text-ink-900" data-pagefind-meta="title">{entry.data.title}</h1>
          {entry.data.aliases && entry.data.aliases.length > 0 && (
            <p class="mt-1 text-sm text-ink-400">
              Also known as: {entry.data.aliases.join(', ')}
            </p>
          )}
          {entry.data.description && (
            <p class="mt-2 text-ink-500 italic">{entry.data.description}</p>
          )}
        </header>

        {entry.data.quote && (
          <blockquote class="border-l-3 border-parchment-400 pl-4 my-6 text-ink-500 italic">
            &ldquo;{entry.data.quote}&rdquo;
          </blockquote>
        )}

        <div class="prose">
          <Content />
        </div>

        {firstAppearanceEntry && (
          <div class="mt-8 pt-4 border-t border-parchment-200">
            <p class="text-sm text-ink-400">
              First appearance:
              <a href={`${base}/diary/${firstAppearanceEntry.id}/`} class="text-accent-600 hover:text-accent-700">
                {firstAppearanceEntry.data.title}
              </a>
            </p>
          </div>
        )}
      </div>

      <!-- Sidebar -->
      <aside class="mt-8 lg:mt-0">
        <div class="bg-parchment-100 rounded-lg p-4 lg:sticky lg:top-20">
          {entry.data.image && (
            <figure class="mb-4">
              <img
                src={`${base}${entry.data.image}`}
                alt={entry.data.imageAlt || entry.data.title}
                class="w-full rounded-md"
                loading="lazy"
              />
              {entry.data.imageAlt && (
                <figcaption class="text-xs text-ink-400 mt-1 text-center">{entry.data.imageAlt}</figcaption>
              )}
            </figure>
          )}
          {appearances.length > 0 && (
            <div>
            <h2 class="font-serif text-lg font-semibold text-ink-800 mb-3">
              Appearances
              <span class="text-sm font-normal text-ink-400 ml-1">({appearances.length})</span>
            </h2>
            <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-1">
              {[...byChapter.entries()].map(([ch, { title, entries }]) => (
                <div>
                  <h3 class="text-xs font-semibold text-ink-500 uppercase tracking-wide mb-1">
                    Ch. {ch}: {title}
                  </h3>
                  <ul class="space-y-0.5">
                    {entries.map(d => (
                      <li>
                        <a href={`${base}/diary/${d.id}/`} class="text-sm text-accent-600 hover:text-accent-700 no-underline hover:underline">
                          S{d.data.session}: {d.data.title}
                        </a>
                      </li>
                    ))}
                  </ul>
                </div>
              ))}
            </div>
            </div>
          )}
        </div>
      </aside>
    </div>
  </article>
</BaseLayout>
